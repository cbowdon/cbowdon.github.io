---
title: "Is experience the biggest predictor of F1 teammate battles?"
date: "2025-04-03"
categories: [r, f1]
warning: false
code-fold: true
freeze: false
draft: true
---

It's just before round three of the 2025 F1 season, Suzuka. Liam Lawson's pre-doomed stint in the Red Bull seat has just finished and Tsunoda is in. Will he fare any better?

Given that Lawson had just 11 races under his belt prior to this season, whereas Tsunoda has 90, I strongly suspect that he will. I _think_ that experience is at least as big a factor in driver performance as natural ability. Let's explore that!

```{r} 
library(tidyverse)
library(knitr)

results <- read_csv("data/results.csv", col_select = c("raceId", "driverId", "constructorId", "positionOrder", "laps", "milliseconds"), col_types = "iiidii", na = "\\N", show_col_types = FALSE)
races <- read_csv("data/races.csv", col_select = c("raceId", "year", "round"), col_types = "iii", show_col_types = FALSE)
drivs <- read_csv("data/drivers.csv", col_select = c("driverId", "driverRef", "code"), na = "\\N", show_col_types = FALSE)
ctors <- read_csv("data/constructors.csv", col_select = c("constructorId", "constructorRef"), show_col_types = FALSE)

race.cars <- races |>
  merge(results) |>
  group_by(year, round) |>
  summarise(n.cars = n())

raw.df <- results |>
  merge(races) |>
  merge(drivs) |>
  merge(ctors) |>
  merge(race.cars)
```

There are three ways we could measure the experience of a driver: number of race starts, number of laps raced, and seasons endured.

```{r}
#| label: tbl-n-starts
#| tbl-cap: Number of race starts, laps raced, and seasons endured for drivers who raced in 2024.
driver.seasons <- raw.df |>
  distinct(driverId, year) |>
  arrange(driverId, year) |>
  group_by(driverId) |>
  mutate(n.seasons = 1, n.seasons = cumsum(n.seasons))

driver.results <- raw.df |>
  group_by(driverId) |>
  arrange(year, raceId) |>
  mutate(n.starts = 1, n.starts = cumsum(n.starts), n.laps = cumsum(laps)) |>
  merge(driver.seasons)

drivers.2024 <- driver.results |>
  group_by(driverId, driverRef, code) |>
  filter(max(year) == 2024) |>
  summarise(n.starts = max(n.starts), n.laps = max(n.laps), n.seasons = max(n.seasons)) |>
  arrange(desc(n.starts))

drivers.2024 |> kable(format.args = list(big.mark = ","))
```

Race starts is the most typical measure of driver experience. You might extend the idea of experience accumulating race by race to experience accumulating lap by lap, which would be particularly helpful to distinguish drivers in their earliest stages for whom every complete race is a significant chunk of experience. We might also consider whether the number of different cars raced helps, which is the same as the number of seasons except for those rare occasions when a driver jumps into two different cars in one seasons.

For now I'm going to ignore career breaks to simplify things. However we definitely saw that Schumacher, Ocon, and Alonso underperformed after their breaks.

With each measure calculated for each driver for each race, we can look at how the difference in experience measure relates to teammate battle outcomes. For each pairing, for each race, we will calculate who finished ahead and each experience measure at the time.


```{r}
#| label: fig-scatter
#| fig-caption: Frequency of finishing ahead of junior teammate by different measures of experience.
teammate.diffs <- driver.results |>
  filter(year >= 2010) |> # modern era
  group_by(year, round, constructorId) |>
  mutate(
    finished.ahead = positionOrder == min(positionOrder),
    seniority = if_else(n.laps == max(n.laps), 1, -1),
    n.laps.diff = seniority * (max(n.laps) - min(n.laps)),
    n.starts.diff = seniority * (max(n.starts) - min(n.starts)),
    n.seasons.diff = seniority * (max(n.seasons) - min(n.seasons))
  ) |>
  filter(seniority > 0) |>
  arrange(year, round, constructorId) |>
  ungroup()

ggplot(pivot_longer(teammate.diffs, ends_with("diff"), names_to = "metric")) +
  aes(x = value, fill = finished.ahead) +
  facet_wrap(~metric, scales = "free") +
  geom_histogram(position = "fill", bins = 10) +
  geom_hline(yintercept = 0.50, linetype = "dashed") +
  scale_fill_manual(values = c("#ffeecc", "steelblue")) +
  labs(
    x = "Experience advantage over junior team mate",
    y = "Frequency of finishing ahead",
    fill = "Finished ahead"
  ) +
  theme_minimal()
```

There's a clear advantage to greater experience. How exactly we measure it doesn't seem to make much difference, so we can stick to measuring experience in terms of race starts.

Now let's try a logistic regression to get the odds ratios. We'll include the year and constructor as fixed effects. Sadly I can't separate out natural talent, but to an extent experience is a function of natural talent: those with more talent are generally welcome to drive for longer.

It's quite likely that the effect of difference in experience is nonlinear (e.g. 2 races might be twice as good as 1 race, but 200 races is only slightly better than 100 races) so let's include a nonlinear term.

```{r}
model.data <- mutate(teammate.diffs, n.starts.diff = scale(n.starts.diff))

model.2 <- glm(
  finished.ahead ~ I(n.starts.diff^2) + n.starts.diff + factor(year) + factor(constructorId),
  family = "binomial",
  data = model.data,
  control = list(maxit = 100)
)
```

If we compare these to a null model without the experience variable, we see that it is significant. A version without the nonlinear term had a P-value of 0.14, so not significant.

```{r}
null.model <- glm(finished.ahead ~ factor(year) + factor(constructorId), family = "binomial", data = model.data)
anova(null.model, model.2)
```

We can interpret the model coefficients as an odds ratio, though we need to remember that this data is standard-scaled.

```{r}
beta1 <- coefficients(model.2)["n.starts.diff"]
beta2 <- coefficients(model.2)["I(n.starts.diff^2)"]

# We have to undo scaling
scaled <- scale(teammate.diffs$n.starts.diff)
mu <- attr(scaled, "scaled:center")
sigma <- attr(scaled, "scaled:scale")

model.odds.ratio <- function(n.starts.diff) {
  scaled.increase <- (n.starts.diff + 1 - mu) / sigma
  scaled.val <- (n.starts.diff - mu) / sigma
  exp(beta1 * (scaled.increase - scaled.val) + beta2 * (scaled.increase^2 - scaled.val^2))
}

#predict(model.2, model.data, type="link")
```

TODO rewrite:

That's a fairly weak odds ratio, but remember odds ratios compound. If we apply that to the 2025 grid (as of Suzuka FP2) we get some interesting numbers.

```{r}
#| label: tbl-odds-ratios
#| tbl-cap: Odds ratio of more experienced driver finishing ahead in each 2025 team version.
drivers.2025 <- tribble(
  ~driverRef, ~code, ~constructorRef, ~version,
  "norris", "NOR", "mclaren", 1,
  "piastri", "PIA", "mclaren", 1,
  "leclerc", "LEC", "ferrari", 1,
  "hamilton", "HAM", "ferrari", 1,
  "max_verstappen", "VER", "red_bull", 1,
  "lawson", "LAW", "red_bull", 1,
  "max_verstappen", "VER", "red_bull", 2,
  "tsunoda", "TSU", "red_bull", 2,
  "russell", "RUS", "mercedes", 1,
  "antonelli", "ANT", "mercedes", 1,
  "alonso", "ALO", "aston_martin", 1,
  "stroll", "STR", "aston_martin", 1,
  "sainz", "SAI", "williams", 1,
  "albon", "ALB", "williams", 1,
  "gasly", "GAS", "alpine", 1,
  "doohan", "DOO", "alpine", 1,
  "tsunoda", "TSU", "racing_bulls", 1,
  "hadjar", "HAD", "racing_bulls", 1,
  "lawson", "LAW", "racing_bulls", 2,
  "hadjar", "HAD", "racing_bulls", 2,
  "ocon", "OCO", "haas", 1,
  "bearman", "BEA", "haas", 1,
  "hulkenberg", "HUL", "sauber", 1,
  "bortoleto", "BOR", "sauber", 1
)

drivers.2025 |>
  merge(drivers.2024, all.x = TRUE) |>
  mutate(n.starts = coalesce(n.starts, 0)) |>
  group_by(constructorRef, version) |>
  arrange(desc(n.starts)) |>
  summarise(
    pairing = sprintf("%s - %s", first(code), last(code)),
    n.starts.diff = first(n.starts) - last(n.starts),
    odds.ratio = odds.ratio^n.starts.diff
  ) |>
  arrange(desc(n.starts.diff)) |>
  kable(digits = 2)
```

This tells us that based on experience alone, Alonso is 2.5 times as likely to finish ahead as Stroll is. It's an intuitive result - in fact they all are, with a couple of exceptions: in our current sample of _two_ grands prix, Hamilton and Sainz are below expectation. But of course both have just made big moves and aren't yet settled in their new cars.

It's a bit of a surprise that the McLaren boys are the second most equally experienced teammates on the grid, after Racing Bulls version 2.

What next? We could include the experience level of the two drivers directly (rather than the diff) because it's likely that driving ability develops nonlinearly with experience e.g. two races being twice as good as one, but two hundred races not being twice as good as one hundred.
