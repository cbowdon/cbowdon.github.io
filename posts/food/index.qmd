---
title: "Food"
date: "2025-05-19"
categories: [food, uk, r]
code-fold: true
freeze: false
---


```{r}
library(httr2)

url <- "https://data.food.gov.uk/catalog/datasets/0bfd916a-4e01-4cb8-ba16-763f0b36b50c"

html_content <- request(url) |>
  req_perform() |>
  resp_body_string()

library(rvest)

# Assuming html_content is already defined
doc <- read_html(html_content)
xlsx_links <- doc %>% html_nodes("a[href$='.xlsx']") %>% html_attr("href")
for (link in xlsx_links) {
  file_url <- link
  file_name <- basename(file_url)
  download.file(url = file_url, destfile = sprintf("data/%s", file_name))
}
```


```{r}
library(tidyverse)
library(readxl)

extract_month_year <- function(file) {
  decoded_filename <- URLdecode(file)

  month_year_regex <- "^.*(January|February|March|April|May|June|July|August|September|October|November|December)\\s?(\\d{2}|\\d{4}).*.xlsx$"

  if (grepl(month_year_regex, decoded_filename)) {
    extracted_month_year <- regmatches(
      decoded_filename,
      regexec(month_year_regex, decoded_filename)
    )

    # Extract month and year
    month <- extracted_month_year[[1]][[2]]
    year <- extracted_month_year[[1]][[3]]

    if (str_length(year) == 2) {
      year <- paste0("20", year)
    }

    return(list(filename = file, month = month, year = year))
  } else {
    print(file)
    return(NULL)
  }
}


xlsx_files <- list.files(path = "data", pattern = "*.xlsx", full.names = TRUE)

periods <- xlsx_files |>
  lapply(extract_month_year) |>
  bind_rows() |>
  arrange(year, month) |>
  mutate(
    month_number = match(
      month,
      c(
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
      )
    )
  ) |>
  arrange(year, month_number)


extract_q12_14 <- function(file) {
  fmy <- extract_month_year(file)

  data <- read_excel(file, sheet = "Percents", col_names = FALSE)

  has_question <- any(str_starts(pull(data, `...1`), "Q12_14"))

  if (!is.na(has_question)) {
    data |>
      filter(!is.na(`...1`)) |>
      slice(
        which(str_starts(`...1`, "Q12_14")):n()
      ) |>
      head(10) |> # take the cats
      tail(-1) |> # drop the header
      mutate(
        filename = fmy$filename,
        monthname = fmy$month,
        year = fmy$year,
        month = match(
          monthname,
          c(
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December"
          )
        )
      )
  }
}

df <- xlsx_files |>
  sort(decreasing = TRUE) |>
  lapply(extract_q12_14) |>
  filter(\(x) !is.null(x)) |>
  bind_rows()
```